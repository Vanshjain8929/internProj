<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic View - CGHS</title>
    <link rel="stylesheet" href="newtopicpage.css">
</head>
<body>
    <div class="header">
        ‡§†‡•ã‡§∏‡§æ‡§µ‡§∏‡•ç‡§•‡§æ ‡§≠‡•å‡§§‡§ø‡§ï‡•Ä ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡§∂‡§æ‡§≤‡§æ ‡§¨‡•Å‡§≤‡•á‡§ü‡§ø‡§® ‡§¨‡•ã‡§∞‡•ç‡§° / Solid State Physics Laboratory Bulletin Board
    </div>

    <div class="nav-bar">
        <div class="nav-left">
            <a href="index.html" class="breadcrumb-link">üè† Board Index</a>
            <span>&gt;</span>
            <a href="cghs.html" class="breadcrumb-link">üè• ‡§∏‡•Ä‡§ú‡•Ä‡§è‡§ö‡§è‡§∏/CGHS</a>
            <span>&gt;</span>
            <span id="topicBreadcrumb">Topic</span>
        </div>
        <div class="nav-right">
            <input id="searchInput" class="search-input" type="search" placeholder="search....">
            <span id="realtime-clock"></span>
        </div>
    </div>

    <div class="container">
        <div id="loadingSection" class="loading">
            <div class="spinner"></div>
            <p>Loading topic...</p>
        </div>

        <div id="errorSection" class="no-topic" style="display: none;">
            <div class="error-message">
                <h3>Topic Not Found</h3>
                <p>The requested topic could not be found or may have been deleted.</p>
            </div>
            <a href="cghs.html" class="download-btn">‚Üê Back to CGHS Forum</a>
        </div>

        <div id="topicContent" style="display: none;">
            <div class="topic-header">
                <h1 class="topic-title" id="topicTitle">Loading...</h1>
                <div class="topic-meta">
                    <span>üë§ By <strong id="topicAuthor">Unknown</strong></span>
                    <span>üìÖ <span id="topicDate">Unknown</span></span>
                    <span>üí¨ <span id="replyCount">0</span> replies</span>
                    <span>üëÅÔ∏è <span id="viewCount">0</span> views</span>
                </div>
                <div class="topic-tags" id="topicTags">
                    <!-- Tags will be inserted here -->
                </div>
            </div>

            <div class="post-container">
                <div class="post-header">
                    <div class="author-info">
                        <div class="author-avatar" id="authorAvatar">A</div>
                        <div class="author-details">
                            <h4 id="postAuthor">Author</h4>
                            <div class="post-date" id="postDate">Date</div>
                        </div>
                    </div>
                </div>

                <div class="post-content" id="postContent">
                    <!-- Topic content will be inserted here -->
                </div>

                <div id="attachmentsSection" class="attachments-section" style="display: none;">
                    <div class="attachments-title">
                        üìé Attachments
                    </div>
                    <div class="attachment-list" id="attachmentList">
                        <!-- Attachments will be inserted here -->
                    </div>
                </div>

                <div id="pollSection" class="poll-section" style="display: none;">
                    <div class="poll-title">
                        üìä <span id="pollQuestion">Poll Question</span>
                    </div>
                    <div id="pollOptions">
                        <!-- Poll options will be inserted here -->
                    </div>
                    <div class="poll-stats" id="pollStats">
                        <!-- Poll statistics will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-nav">
        üè† <a href="index.html">Return to Board Index</a> | 
        <a href="cghs.html">Return to CGHS Forum</a>
    </div>

    <script>
        // Clock functionality
        function updateClock() {
            const now = new Date();
            const options = {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            const formatted = now.toLocaleString('en-GB', options).replace(',', '');
            document.getElementById('realtime-clock').textContent = formatted;
        }

        // Load topic data
        function loadTopic() {
            const urlParams = new URLSearchParams(window.location.search);
            const topicId = urlParams.get('id');
            
            if (!topicId) {
                showError();
                return;
            }

            // Get stored topics
            const storedTopics = localStorage.getItem('cghsTopics');
            let topics = [];
            
            if (storedTopics) {
                try {
                    topics = JSON.parse(storedTopics);
                } catch (error) {
                    console.error('Error parsing stored topics:', error);
                    showError();
                    return;
                }
            }

            // Find the topic
            const topic = topics.find(t => t.id === parseInt(topicId));
            
            if (!topic) {
                showError();
                return;
            }

            displayTopic(topic);
        }

        function showError() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
        }

        function displayTopic(topic) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('topicContent').style.display = 'block';

            // Update breadcrumb
            document.getElementById('topicBreadcrumb').textContent = topic.title;

            // Update topic header
            document.getElementById('topicTitle').textContent = topic.title;
            document.getElementById('topicAuthor').textContent = topic.author;
            document.getElementById('topicDate').textContent = topic.date;
            document.getElementById('replyCount').textContent = '0'; // No replies yet
            document.getElementById('viewCount').textContent = Math.floor(Math.random() * 50) + 1;

            // Update post content
            document.getElementById('postAuthor').textContent = topic.author;
            document.getElementById('postDate').textContent = topic.date;
            document.getElementById('authorAvatar').textContent = topic.author.charAt(0).toUpperCase();
            
            // Display message content
            const postContent = document.getElementById('postContent');
            postContent.innerHTML = topic.message || '<p>No content available.</p>';

            // Display topic tags
            const tagsContainer = document.getElementById('topicTags');
            if (topic.type && topic.type !== 'normal') {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.textContent = topic.type.charAt(0).toUpperCase() + topic.type.slice(1);
                tagsContainer.appendChild(tag);
            }
            if (topic.locked) {
                const lockTag = document.createElement('span');
                lockTag.className = 'tag';
                lockTag.textContent = 'üîí Locked';
                tagsContainer.appendChild(lockTag);
            }

            // Display attachments
            if (topic.files && topic.files.length > 0) {
                displayAttachments(topic.files);
            }

            // Display poll
            if (topic.poll && topic.pollQuestion) {
                displayPoll(topic);
            }

            // Update page title
            document.title = `${topic.title} - CGHS - Solid State Physics Laboratory`;
        }

        function displayAttachments(files) {
            const attachmentsSection = document.getElementById('attachmentsSection');
            const attachmentList = document.getElementById('attachmentList');
            
            attachmentsSection.style.display = 'block';
            attachmentList.innerHTML = '';

            files.forEach((file, index) => {
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';

                const fileIcon = getFileIcon(file.type);
                const fileSize = formatFileSize(file.size);

                attachmentItem.innerHTML = `
                    <div class="attachment-info">
                        <div class="file-icon ${getFileIconClass(file.type)}">
                            ${fileIcon}
                        </div>
                        <div class="file-details">
                            <h4>${file.name}</h4>
                            <div class="file-size">${fileSize} ‚Ä¢ ${file.type || 'Unknown type'}</div>
                        </div>
                    </div>
                    <button class="download-btn" onclick="downloadFile(${index})">
                        üì• Download
                    </button>
                `;

                attachmentList.appendChild(attachmentItem);
            });
        }

        function displayPoll(topic) {
            const pollSection = document.getElementById('pollSection');
            const pollQuestion = document.getElementById('pollQuestion');
            const pollOptions = document.getElementById('pollOptions');
            const pollStats = document.getElementById('pollStats');

            pollSection.style.display = 'block';
            pollQuestion.textContent = topic.pollQuestion;

            pollOptions.innerHTML = '';
            topic.pollOptions.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'poll-option';
                optionDiv.innerHTML = `
                    <input type="radio" name="pollVote" value="${index}" id="poll_${index}">
                    <label for="poll_${index}">${option}</label>
                `;
                pollOptions.appendChild(optionDiv);
            });

            pollStats.innerHTML = `
                <strong>Poll Details:</strong><br>
                Duration: ${topic.pollDuration || 7} days ‚Ä¢ 
                Max votes per user: ${topic.maxVotes || 1} ‚Ä¢ 
                Total votes: 0
            `;
        }

        function getFileIcon(type) {
            if (type && type.startsWith('image/')) return 'üñºÔ∏è';
            if (type && type.includes('pdf')) return 'üìÑ';
            if (type && type.includes('document') || type && type.includes('word')) return 'üìù';
            if (type && type.includes('text')) return 'üìÑ';
            return 'üìÅ';
        }

        function getFileIconClass(type) {
            if (type && type.startsWith('image/')) return 'image';
            if (type && (type.includes('pdf') || type.includes('document') || type.includes('word'))) return 'document';
            if (type && type.includes('text')) return 'text';
            return 'default';
        }

        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown size';
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadFile(fileIndex) {
            const urlParams = new URLSearchParams(window.location.search);
            const topicId = urlParams.get('id');
            
            const storedTopics = localStorage.getItem('cghsTopics');
            if (!storedTopics) return;

            try {
                const topics = JSON.parse(storedTopics);
                const topic = topics.find(t => t.id === parseInt(topicId));
                
                if (!topic || !topic.files || !topic.files[fileIndex]) {
                    alert('File not found!');
                    return;
                }

                const file = topic.files[fileIndex];
                
                // Create download link
                const downloadLink = document.createElement('a');
                downloadLink.href = file.url;
                downloadLink.download = file.name;
                downloadLink.style.display = 'none';
                
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                // Show success message
                showSuccessMessage(`Downloading ${file.name}...`);
                
            } catch (error) {
                console.error('Error downloading file:', error);
                alert('Error downloading file. Please try again.');
            }
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: #28a745; color: white; 
                padding: 15px 20px; border-radius: 8px; 
                z-index: 1000; font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideInRight 0.5s ease-out;
            `;
            successDiv.textContent = message;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.style.animation = 'slideOutRight 0.5s ease-in';
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 500);
            }, 3000);
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const content = document.getElementById('postContent');
            
            if (query.trim() === '') {
                // Reset highlighting
                content.innerHTML = content.textContent;
                return;
            }

            // Simple highlighting (you can improve this)
            const text = content.textContent;
            const highlightedText = text.replace(
                new RegExp(query, 'gi'), 
                match => `<mark style="background: yellow; color: black;">${match}</mark>`
            );
            content.innerHTML = highlightedText;
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateClock();
            setInterval(updateClock, 1000);
            loadTopic();
        });

        // CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            mark {
                padding: 2px 4px;
                border-radius: 3px;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>