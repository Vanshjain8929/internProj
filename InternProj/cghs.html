<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§∏‡•Ä‡§ú‡•Ä‡§è‡§ö‡§è‡§∏/CGHS</title>
    <link rel="stylesheet" href="cghs.css">
</head>

<body>
    <div class="header">
        ‡§†‡•ã‡§∏‡§æ‡§µ‡§∏‡•ç‡§•‡§æ ‡§≠‡•å‡§§‡§ø‡§ï‡•Ä ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡§∂‡§æ‡§≤‡§æ ‡§¨‡•Å‡§≤‡•á‡§ü‡§ø‡§® ‡§¨‡•ã‡§∞‡•ç‡§° / Solid State Physics Laboratory Bulletin Board
    </div>

    <div class="nav-bar">
        <div class="nav-left">
            <a href="cghs.html" class="breadcrumb-link">üè• ‡§∏‡•Ä‡§ú‡•Ä‡§è‡§ö‡§è‡§∏/CGHS</a>
        </div>
        <div class="nav-right">
            <input id="searchInput" class="search-input" type="search" placeholder="search....">
            <a href="login.html" class="login-link">‚öô Login</a>
            <span id="realtime-clock"></span>
        </div>
    </div>

    <div class="container">
        <div class="forum-header">Topics</div>

        <div class="stats-summary">
            <a href="login.html?redirect=cghsnewtopic.html" class="new-topic-btn">‚ûï New Topic</a>
            <span id="topic-count">12 topics . page 1 of 1</span>
        </div>

        <div class="forum-topic-list" id="topicList">
            <!-- New topics will be inserted here dynamically -->
            
            <!-- Existing topics -->
            <div class="forum-topic">
                <a href="#" class="forum-title">CGHS Latest Guidelines</a>
                <p class="topic-stat">Last post by <strong>saketmittal</strong> ‚Ä¢ 01 Jul 2024, 12:30</p>
            </div>
            <div class="forum-topic">
                <a href="#" class="forum-title">CGHS Rate List Updated</a>
                <p class="topic-stat">Last post by <strong>saketmittal</strong> ‚Ä¢ 09 Feb 2024, 12:45</p>
            </div>
            <div class="forum-topic">
                <a href="#" class="forum-title">CGHS Own Diagnostic Laboratories</a>
                <p class="topic-stat">Last post by <strong>saketmittal</strong> ‚Ä¢ 12 May 2022, 10:17</p>
            </div>
            <div class="forum-topic">
                <a href="#" class="forum-title">CGHS Empanelled Hospitals & Diagnostic Centres - Delhi / NCR</a>
                <p class="topic-stat">Last post by <strong>saketmittal</strong> ‚Ä¢ 05 May 2022, 09:31</p>
            </div>
            <div class="forum-topic">
                <a href="#" class="forum-title">CGHS COVID-19 Orders</a>
                <p class="topic-stat">Last post by <strong>saketmittal</strong> ‚Ä¢ 18 Jun 2020, 10:35</p>
            </div>
            <div class="forum-topic">
                <a href="#" class="forum-title">Medical Claim Forms</a>
                <p class="topic-stat">Last post by <strong>boardadmin</strong> ‚Ä¢ 14 Oct 2019, 09:56</p>
            </div>
            <div class="forum-topic">
                <a href="#" class="forum-title">CGHS Ayush - Ayurvedic Treatment</a>
                <p class="topic-stat">Last post by <strong>saketmittal</strong> ‚Ä¢ 02 Jan 2018, 10:39</p>
            </div>
            <div class="forum-topic">
                <a href="#" class="forum-title">CGHS - Miscellaneous Orders</a>
                <p class="topic-stat">Last post by <strong>saketmittal</strong> ‚Ä¢ 21 Nov 2017, 10:34</p>
            </div>
            <div class="forum-topic">
                <a href="#" class="forum-title">CGHS Simplification of Procedure for Treatment at Empanelled Private
                    Hospitals</a>
                <p class="topic-stat">Last post by <strong>saketmittal</strong> ‚Ä¢ 10 Nov 2017, 09:12</p>
            </div>
            <div class="forum-topic">
                <a href="#" class="forum-title">CGHS Forms</a>
                <p class="topic-stat">Last post by <strong>saketmittal</strong> ‚Ä¢ 06 Jun 2017, 13:46</p>
            </div>
            <div class="forum-topic">
                <a href="#" class="forum-title">CGHS Rate List</a>
                <p class="topic-stat">Last post by <strong>saketmittal</strong> ‚Ä¢ 06 Jun 2017, 13:41</p>
            </div>
            <div class="forum-topic">
                <a href="#" class="forum-title">CGHS Revised Subscription</a>
                <p class="topic-stat">Last post by <strong>saketmittal</strong> ‚Ä¢ 06 Jun 2017, 11:45</p>
            </div>
        </div>
    </div>

    <div class="forum-footer">
        <div class="who-online">
            <h4>üë§ Who is Online</h4>
            <p>Users browsing this forum: <strong>None</strong>. No registered users and 1 guest</p>
        </div>

        <div class="forum-permissions">
            <h4>üõ° Forum Permissions</h4>
            <ul>
                <li>You <strong>can</strong> post new topics in this forum</li>
                <li>You <strong>can</strong> reply to topics in this forum</li>
                <li>You <strong>can</strong> edit your posts in this forum</li>
                <li>You <strong>can</strong> delete your posts in this forum</li>
                <li>You <strong>can</strong> post attachments in this forum</li>
            </ul>
        </div>
    </div>

    <div class="footer-nav">
        üè† <a href="index.html"> Return to Board Index</a>
    </div>

    <script>

let cghsTopics = [];
let topicIdCounter = 1;
let processedTopicIds = new Set(); // Track processed topics to prevent duplicates

// Topic Counter Management
function updateTopicCounts() {
    const storedCounts = JSON.parse(localStorage.getItem('topic-count') || '{}');
    
    // Set default counts if not stored
    const defaultCounts = {
        'admin': 5, 'cghs': 12, 'canteen': 3, 'finance': 6, 'hrd': 5,
        'it': 6, 'instrumentation': 2, 'library': 3, 'material': 6,
        'mask': 4, 'public': 5, 'qms': 4, 'sspl': 3, 'sports': 2,
        'technical': 1, 'wetcanteen': 1, 'works': 1, 'workshop': 1
    };
    
    const counts = { ...defaultCounts, ...storedCounts };
    localStorage.setItem('topic-count', JSON.stringify(counts));
    return counts;
}

function incrementCGHSCount() {
    const counts = updateTopicCounts();
    counts.cghs = (counts.cghs || 12) + 1;
    localStorage.setItem('topic-count', JSON.stringify(counts));
    return counts.cghs;
}

function decrementCGHSCount() {
    const counts = updateTopicCounts();
    counts.cghs = Math.max((counts.cghs || 12) - 1, 0);
    localStorage.setItem('topic-count', JSON.stringify(counts));
    return counts.cghs;
}

// Initialize topic ID counter
function initializeTopicIdCounter() {
    const storedCounter = localStorage.getItem('topicIdCounter');
    if (storedCounter) {
        topicIdCounter = parseInt(storedCounter);
    }
}

function getNextTopicId() {
    const id = topicIdCounter++;
    localStorage.setItem('topicIdCounter', topicIdCounter.toString());
    return id;
}

// Load topics from localStorage on page load
function loadStoredTopics() {
    const storedTopics = localStorage.getItem('cghsTopics');
    if (storedTopics) {
        try {
            const topics = JSON.parse(storedTopics);
            cghsTopics = topics;
            topics.forEach(topic => {
                if (!processedTopicIds.has(topic.id)) {
                    addNewTopicToDOM(topic);
                    processedTopicIds.add(topic.id);
                }
            });
            updateTopicCount();
        } catch (error) {
            console.error('Error loading stored topics:', error);
        }
    }
}

// Save topics to localStorage
function saveTopicsToStorage() {
    try {
        localStorage.setItem('cghsTopics', JSON.stringify(cghsTopics));
    } catch (error) {
        console.error('Error saving topics:', error);
    }
}

// Add new topic with counter synchronization
function addNewTopic(topicData) {
    // Check if topic already exists to prevent duplicates
    if (cghsTopics.find(t => t.id === topicData.id)) {
        console.log('Topic already exists, skipping duplicate');
        return;
    }
    
    // Assign unique ID if not present
    if (!topicData.id) {
        topicData.id = getNextTopicId();
    }
    
    // Check if already processed
    if (processedTopicIds.has(topicData.id)) {
        console.log('Topic already processed, skipping');
        return;
    }
    
    // Add to DOM
    addNewTopicToDOM(topicData);
    processedTopicIds.add(topicData.id);
    
    // Add to array
    cghsTopics.unshift(topicData);
    
    // Save topics to localStorage
    saveTopicsToStorage();
    
    // Increment counter and update display
    const newCount = incrementCGHSCount();
    updateTopicCount();
    
    // Show success message
    showSuccessMessage(`Topic posted successfully! Total CGHS topics: ${newCount}`);
    
    window.dispatchEvent(new StorageEvent('storage', {
        key: 'topic-count',
        newValue: localStorage.getItem('topic-count')
    }));
    
    // Dispatch custom event for same-tab updates
    window.dispatchEvent(new CustomEvent('topicCountUpdated', {
        detail: { category: 'cghs', newCount: newCount }
    }));
}

// Delete topic function
function deleteTopic(topicId) {
    if (!confirm('Are you sure you want to delete this topic? This action cannot be undone.')) {
        return;
    }
    
    // Find and remove from array
    const topicIndex = cghsTopics.findIndex(t => t.id === topicId);
    if (topicIndex === -1) {
        console.error('Topic not found in array');
        return;
    }
    
    const topicTitle = cghsTopics[topicIndex].title;
    cghsTopics.splice(topicIndex, 1);
    
    // Remove from DOM
    const topicElement = document.querySelector(`[data-topic-id="${topicId}"]`);
    if (topicElement) {
        topicElement.style.animation = 'fadeOutLeft 0.5s ease-in';
        setTimeout(() => {
            topicElement.remove();
            updateTopicCount();
        }, 500);
    }
    
    // Remove from processed set
    processedTopicIds.delete(topicId);
    
    // Save updated topics to localStorage
    saveTopicsToStorage();
    
    // Decrement counter
    const newCount = decrementCGHSCount();
    
    // Show success message
    showSuccessMessage(`Topic "${topicTitle}" deleted successfully! Total CGHS topics: ${newCount}`);
    
     // Notify other tabs/windows AND same page about the update
     window.dispatchEvent(new StorageEvent('storage', {
        key: 'topic-count',
        newValue: localStorage.getItem('topic-count')
    }));
    
    // Dispatch custom event for same-tab updates
    window.dispatchEvent(new CustomEvent('topicCountUpdated', {
        detail: { category: 'cghs', newCount: newCount }
    }));
}

// Add topic to DOM only
function addNewTopicToDOM(topicData) {
    const topicList = document.getElementById('topicList');
    
    const newTopicElement = document.createElement('div');
    newTopicElement.className = 'forum-topic';
    newTopicElement.setAttribute('data-topic-id', topicData.id);
    
    let topicTypeIcon = '';
    let specialClass = '';
    
    switch(topicData.type) {
        case 'sticky':
            topicTypeIcon = 'üìå ';
            specialClass = 'sticky-topic';
            break;
        case 'announce':
            topicTypeIcon = 'üì¢ ';
            specialClass = 'announce-topic';
            break;
        case 'global':
            topicTypeIcon = 'üåê ';
            specialClass = 'global-topic';
            break;
        default:
            topicTypeIcon = '';
            specialClass = 'new-topic';
    }
    
    const lockIcon = topicData.locked ? ' üîí' : '';
    const pollIcon = topicData.poll ? ' üìä' : '';
    const attachmentIcon = topicData.files && topicData.files.length > 0 ? ' üìé' : '';
    
    // Create clickable link to topic page
    const topicUrl = `newtopicpage.html?id=${topicData.id}`;
    
    newTopicElement.innerHTML = `
        <div class="topic-content">
            <a href="${topicUrl}" class="forum-title ${specialClass}">
                ${topicTypeIcon}${topicData.title}${lockIcon}${pollIcon}${attachmentIcon}
            </a>
            <p class="topic-stat">Last post by <strong>${topicData.author}</strong> ‚Ä¢ ${topicData.date}</p>
        </div>
        <div class="topic-actions">
            <button class="delete-btn" onclick="deleteTopic(${topicData.id})" title="Delete Topic">
                üóëÔ∏è
            </button>
        </div>
    `;
    
    topicList.insertBefore(newTopicElement, topicList.firstChild);
    newTopicElement.style.animation = 'highlightNew 3s ease-in-out';
}

// Update topic count display
function updateTopicCount() {
    const currentTopics = document.querySelectorAll('.forum-topic').length;
    const topicCountElement = document.getElementById('topic-count');
    if (topicCountElement) {
        topicCountElement.textContent = `${currentTopics} topics . page 1 of 1`;
    }
    
    // Sync the stored count with actual DOM count
    const counts = updateTopicCounts();
    counts.cghs = currentTopics;
    localStorage.setItem('topic-count', JSON.stringify(counts));
}

// Clock functionality
function updateClock() {
    const now = new Date();
    const options = {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    };
    const formatted = now.toLocaleString('en-GB', options).replace(',', '');
    document.getElementById('realtime-clock').textContent = formatted;
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    const topics = document.querySelectorAll('.forum-topic');
    let matchFound = false;

    topics.forEach(topic => {
        const title = topic.querySelector('.forum-title').textContent.toLowerCase();
        if (title.includes(query)) {
            topic.style.display = 'block';
            matchFound = true;
        } else {
            topic.style.display = 'none';
        }
    });

    let noResultDiv = document.getElementById('no-results');
    if (!matchFound && query.trim() !== '') {
        if (!noResultDiv) {
            noResultDiv = document.createElement('div');
            noResultDiv.id = 'no-results';
            noResultDiv.style.color = 'lightgray';
            noResultDiv.style.textAlign = 'center';
            noResultDiv.style.marginTop = '20px';
            noResultDiv.textContent = 'No results found.';
            document.querySelector('.forum-topic-list').appendChild(noResultDiv);
        }
    } else if (noResultDiv) {
        noResultDiv.remove();
    }
});

// Check for new topic in URL parameters (FIXED - only process once)
function checkForNewTopic() {
    // No longer needed since all topics are now saved in localStorage.
}


// Show success message
function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.style.cssText = `
        position: fixed; top: 20px; right: 20px; 
        background: #28a745; color: white; 
        padding: 15px 20px; border-radius: 8px; 
        z-index: 1000; font-weight: bold;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideInRight 0.5s ease-out;
    `;
    successDiv.textContent = message;
    
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        successDiv.style.animation = 'slideOutRight 0.5s ease-in';
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 500);
    }, 3000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeTopicIdCounter(); // Initialize topic ID counter
    updateTopicCounts(); // Initialize counts
    loadStoredTopics(); // Load stored topics
    checkForNewTopic(); // Check for new topic from URL (only once)
    setInterval(updateClock, 1000); // Start clock
    updateClock(); // Initial clock update
});

// CSS animations
const style = document.createElement('style');
style.textContent = `
   
    .delete-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s ease;
    }
    
    .delete-btn:hover {
        background: #c82333;
        transform: scale(1.05);
    }
    
    .delete-btn:active {
        transform: scale(0.95);
    }
    
    
`;
document.head.appendChild(style);
    </script>
</body>
</html>